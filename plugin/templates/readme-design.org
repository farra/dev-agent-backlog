#+TITLE: Design Documents
#+SETUPFILE: ../../org-setup.org

* Overview

This directory contains design documents following an RFC/RFD pattern.
Each document captures a decision, its rationale, and implementation tasks.

* Document Status

| Status   | Meaning                                          |
|----------+--------------------------------------------------|
| Draft    | Under development, not ready for review          |
| Review   | Ready for feedback                               |
| Accepted | Approved, ready to implement                     |
| Active   | Implementation in progress, some tasks complete  |
| Complete | Fully implemented and verified                   |
| Archived | No longer active (rejected, obsolete, abandoned) |

* Documents

| Doc | Title    | Status |
|-----+----------+--------|
| 000 | [[file:000-template.org][Template]] | N/A    |

* Maintenance Elisp
:PROPERTIES:
:header-args:elisp: :results silent
:END:

Helper functions for maintaining this index. Evaluate the source block with =C-c C-c=,
then use the interactive commands.

#+begin_src elisp
;;; Design Doc Maintenance -*- lexical-binding: t -*-

(defvar design/dir (file-name-directory (buffer-file-name))
  "Directory containing design documents.")

(defvar design/valid-statuses
  '("Draft" "Review" "Accepted" "Active" "Complete" "Archived")
  "Valid status values for design documents.")

(defun design/--extract-status (file)
  "Extract #+STATUS: value from FILE."
  (when (file-exists-p file)
    (with-temp-buffer
      (insert-file-contents file nil 0 1000)
      (goto-char (point-min))
      (when (re-search-forward "^#\\+STATUS:\\s-*\\(.+\\)$" nil t)
        (string-trim (match-string 1))))))

(defun design/--extract-category (file)
  "Extract #+CATEGORY: value from FILE."
  (when (file-exists-p file)
    (with-temp-buffer
      (insert-file-contents file nil 0 1000)
      (goto-char (point-min))
      (when (re-search-forward "^#\\+CATEGORY:\\s-*\\(.+\\)$" nil t)
        (string-trim (match-string 1))))))

(defun design/--extract-title (file)
  "Extract #+TITLE: value from FILE."
  (when (file-exists-p file)
    (with-temp-buffer
      (insert-file-contents file nil 0 1000)
      (goto-char (point-min))
      (when (re-search-forward "^#\\+TITLE:\\s-*\\(.+\\)$" nil t)
        (string-trim (match-string 1))))))

(defun design/--get-table-files ()
  "Get list of (number . filename) from tables in current buffer."
  (let (files)
    (save-excursion
      (goto-char (point-min))
      (while (re-search-forward
              "^|\\s-*\\([0-9]+\\)\\s-*|.*\\[\\[file:\\([^]]+\\.org\\)\\]" nil t)
        (push (cons (string-to-number (match-string 1))
                    (match-string 2))
              files)))
    (nreverse files)))

(defun design/--get-all-docs ()
  "Get list of all numbered .org design docs."
  (seq-filter
   (lambda (f)
     (string-match-p "^[0-9]+-" (file-name-nondirectory f)))
   (directory-files design/dir t "\\.org$")))

(defun design/sync-status ()
  "Update status column in tables from actual #+STATUS: in linked files."
  (interactive)
  (let ((updates 0)
        (errors nil))
    (save-excursion
      (goto-char (point-min))
      (while (re-search-forward
              "^|\\s-*\\([0-9]+\\)\\s-*|\\s-*\\[\\[file:\\([^]]+\\.org\\)\\]\\[[^]]+\\]\\]\\s-*|\\s-*\\([^|]+\\)|" nil t)
        (let* ((num (match-string 1))
               (file (expand-file-name (match-string 2) design/dir))
               (current-status (string-trim (match-string 3)))
               (actual-status (design/--extract-status file)))
          (cond
           ((null actual-status)
            (push (format "%s: no #+STATUS: found" num) errors))
           ((not (string= current-status actual-status))
            (let ((status-start (match-beginning 3))
                  (status-end (match-end 3)))
              (delete-region status-start status-end)
              (goto-char status-start)
              (insert (format "%-10s" actual-status))
              (cl-incf updates)))))))
    (if errors
        (message "Updated %d statuses. Errors: %s" updates (string-join errors ", "))
      (message "Updated %d statuses." updates))))

(defun design/verify-links ()
  "Check that all linked files in tables exist."
  (interactive)
  (let ((missing nil))
    (dolist (entry (design/--get-table-files))
      (let ((file (expand-file-name (cdr entry) design/dir)))
        (unless (file-exists-p file)
          (push (format "%03d: %s" (car entry) (cdr entry)) missing))))
    (if missing
        (message "Missing files:\n%s" (string-join (nreverse missing) "\n"))
      (message "All linked files exist."))))

(defun design/find-unlisted ()
  "Find .org files in design dir not listed in this index."
  (interactive)
  (let* ((listed (mapcar #'cdr (design/--get-table-files)))
         (all-docs (design/--get-all-docs))
         (unlisted (seq-filter
                    (lambda (f)
                      (not (member (file-name-nondirectory f)
                                   (mapcar #'file-name-nondirectory
                                           (mapcar (lambda (l) (expand-file-name l design/dir)) listed)))))
                    all-docs)))
    (if unlisted
        (message "Unlisted docs:\n%s"
                 (string-join (mapcar #'file-name-nondirectory unlisted) "\n"))
      (message "All docs are listed in the index."))))

(defun design/stale-check ()
  "Find docs where README status doesn't match actual status."
  (interactive)
  (let ((stale nil))
    (save-excursion
      (goto-char (point-min))
      (while (re-search-forward
              "^|\\s-*\\([0-9]+\\)\\s-*|\\s-*\\[\\[file:\\([^]]+\\.org\\)\\]\\[[^]]+\\]\\]\\s-*|\\s-*\\([^|]+\\)|" nil t)
        (let* ((num (match-string 1))
               (file (expand-file-name (match-string 2) design/dir))
               (readme-status (string-trim (match-string 3)))
               (actual-status (design/--extract-status file)))
          (when (and actual-status (not (string= readme-status actual-status)))
            (push (format "%s: README='%s' actual='%s'"
                          num readme-status actual-status)
                  stale)))))
    (if stale
        (message "Stale entries:\n%s" (string-join (nreverse stale) "\n"))
      (message "All statuses are in sync."))))

(defun design/goto-doc (number)
  "Jump to design doc by NUMBER."
  (interactive "nDoc number: ")
  (let ((file (car (seq-filter
                    (lambda (f)
                      (string-match-p (format "^%03d-" number)
                                      (file-name-nondirectory f)))
                    (design/--get-all-docs)))))
    (if (and file (file-exists-p file))
        (find-file file)
      (user-error "No doc with number %d" number))))

(defun design/next-number ()
  "Return the next available doc number."
  (interactive)
  (let ((next (1+ (apply #'max 0
                         (mapcar (lambda (f)
                                   (if (string-match "^\\([0-9]+\\)-" (file-name-nondirectory f))
                                       (string-to-number (match-string 1 (file-name-nondirectory f)))
                                     0))
                                 (design/--get-all-docs))))))
    (message "Next available doc number: %03d" next)
    next))

(defun design/status-report ()
  "Show a summary of document statuses."
  (interactive)
  (let ((status-counts (make-hash-table :test 'equal)))
    (dolist (file (design/--get-all-docs))
      (let ((status (or (design/--extract-status file) "Unknown")))
        (puthash status (1+ (gethash status status-counts 0)) status-counts)))
    (message "Status report:\n%s"
             (string-join
              (sort (map-apply (lambda (k v) (format "  %-10s %3d" k v))
                               status-counts)
                    #'string<)
              "\n"))))

(defun design/category-report ()
  "Show a summary of document categories."
  (interactive)
  (let ((cat-counts (make-hash-table :test 'equal)))
    (dolist (file (design/--get-all-docs))
      (let ((cat (or (design/--extract-category file) "uncategorized")))
        (puthash cat (1+ (gethash cat cat-counts 0)) cat-counts)))
    (message "Category report:\n%s"
             (string-join
              (sort (map-apply (lambda (k v) (format "  %-12s %3d" k v))
                               cat-counts)
                    #'string<)
              "\n"))))

(message "Design doc helpers loaded. Commands:
  M-x design/sync-status     - Update statuses from files
  M-x design/stale-check     - Find mismatched statuses
  M-x design/verify-links    - Check all links exist
  M-x design/find-unlisted   - Find docs not in index
  M-x design/goto-doc        - Jump to doc by number
  M-x design/next-number     - Next available doc number
  M-x design/status-report   - Status summary
  M-x design/category-report - Category summary")
#+end_src

** Usage

1. Open this file in Emacs
2. Navigate to the elisp block above and press =C-c C-c= to evaluate
3. Use the interactive commands:

| Command                     | Description                             |
|-----------------------------+-----------------------------------------|
| =M-x design/sync-status=    | Update table statuses from actual files |
| =M-x design/stale-check=    | Find where README â‰  actual status       |
| =M-x design/verify-links=   | Ensure all linked files exist           |
| =M-x design/find-unlisted=  | Find .org files not in this index       |
| =M-x design/goto-doc=       | Jump to a doc by its number             |
| =M-x design/next-number=    | Get next available document number      |
| =M-x design/status-report=  | Show count of docs by status            |
| =M-x design/category-report= | Show count of docs by category         |
