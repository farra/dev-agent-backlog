#+TITLE: 011 - Claude Code Plugin Architecture
#+AUTHOR: dev-agent-backlog
#+STATUS: Active
#+CATEGORY: infra
#+CREATED: [2026-01-26]
#+LAST_MODIFIED: [2026-01-26]
#+SETUPFILE: ../../org-setup.org

* Summary

Convert dev-agent-backlog from a shell-script-installed template system into a
Claude Code plugin. This enables installation via =/plugin install=, automatic
skill loading, and an interactive setup experience that replaces =init.sh=.

* Context

** Current State

The project uses =bin/init.sh= to bootstrap new projects:
- Copies template files (org-setup.org, backlog-template.org, etc.)
- Substitutes =PROJECT= placeholder with user's prefix
- Creates directory structure
- Copies commands and skills to =.claude/=

This works but has issues:
- Users must clone the repo or download init.sh
- Template content was duplicated in heredocs (now fixed, uses templates/)
- No easy update path when templates change
- Skills/commands only available after manual copying

** Claude Code Plugins

Claude Code 1.0.33+ supports plugins with:
- Skills (model-invoked behaviors)
- Commands (user-invoked slash commands)
- Hooks (event handlers)
- MCP servers (external tool integration)

Plugins can be installed from URLs/marketplaces and are namespaced to prevent
conflicts.

* Goals and Non-Goals

** Goals

1. Install via =/plugin install <url>= with no shell scripts
2. Commands immediately available as =/backlog:task-queue=, etc.
3. Skills (backlog-resume, backlog-update) work automatically
4. Interactive =/backlog:setup= command replaces init.sh
5. Setup skill can update CLAUDE.md with project context
6. Easy updates when plugin is improved

Success criteria:
- New user can go from zero to working backlog in <2 minutes
- Existing init.sh users can migrate without losing data
- Plugin works across projects without re-installation

** Non-Goals

- Maintaining backwards compatibility with init.sh (deprecate it)
- Supporting pre-1.0.33 Claude Code versions
- Supporting other coding agents initially (methodology is portable, adapters later)

* Proposal

** Overview

This repo becomes a marketplace containing the =backlog= plugin:

#+begin_example
dev-agent-backlog/                    # This repo (marketplace)
├── .claude-plugin/
│   └── marketplace.json              # Lists available plugins
├── plugin/                           # The backlog plugin
│   ├── .claude-plugin/
│   │   └── plugin.json
│   ├── commands/
│   ├── task-queue.md
│   ├── task-start.md
│   ├── task-complete.md
│   ├── task-hold.md
│   ├── new-design-doc.md
│   ├── queue-design-doc.md
│   └── design-review.md
├── skills/
│   ├── backlog-resume/
│   │   └── SKILL.md
│   ├── backlog-update/
│   │   └── SKILL.md
│   ├── new-design-doc/
│   │   └── SKILL.md
│   └── setup/
│       └── SKILL.md
│   └── templates/
│       └── (6 template files)
├── docs/design/                      # Meta-documentation (this system)
├── bin/init.sh                       # Deprecated, points to plugin
└── README.md
#+end_example

** Design

*** Plugin Manifest

#+begin_src json
{
  "name": "backlog",
  "description": "Design doc driven task management for human-agent collaboration",
  "version": "1.0.0",
  "author": {
    "name": "J. Aaron Farr"
  },
  "repository": "https://github.com/farra/backlog-plugin",
  "homepage": "https://github.com/farra/dev-agent-backlog"
}
#+end_src

*** The Setup Skill

The =setup= skill replaces init.sh. It triggers when users say things like:
- "set up design docs for this project"
- "initialize the backlog system"
- "configure design doc workflow"

The skill instructs Claude to:
1. Ask for project prefix (or detect from existing files)
2. Check for existing files to avoid clobbering
3. Create directory structure (docs/design/)
4. Write template files with PROJECT substitution
5. Update or create CLAUDE.md with backlog instructions
6. Explain what was created and how to use it

*** Command Migration

Current commands in =.claude/commands/= move to =commands/= in the plugin.
They become namespaced:

| Current           | Plugin                    |
|-------------------+---------------------------|
| /task-queue       | /backlog:task-queue       |
| /task-start       | /backlog:task-start       |
| /task-complete    | /backlog:task-complete    |
| /task-hold        | /backlog:task-hold        |
| /new-design-doc   | /backlog:new-design-doc   |
| /queue-design-doc | /backlog:queue-design-doc |
| /design-review    | /backlog:design-review    |

*** Skill Migration

Skills move from =.claude/skills/= to =skills/= in the plugin:

| Current         | Plugin                      |
|-----------------+-----------------------------|
| backlog-resume  | backlog:backlog-resume      |
| backlog-update  | backlog:backlog-update      |
| new-design-doc  | backlog:new-design-doc      |
| (new)           | backlog:setup               |

*** Template Handling

Templates stay as files in =templates/=. The setup skill reads them and
performs PROJECT substitution when writing to the user's project.

This is better than init.sh because Claude can:
- Detect existing project prefix from files
- Ask clarifying questions
- Adapt to non-standard project structures
- Explain what each file does as it creates it

*** CLAUDE.md Integration

The setup skill should append or merge backlog instructions into the project's
CLAUDE.md. Content includes:
- Overview of the backlog system
- Available commands and when to use them
- Pointer to design docs directory

** Alternatives Considered

*** Keep init.sh, add plugin alongside

Could keep init.sh for users who prefer shell scripts and add the plugin for
Claude Code users.

Rejected: Maintenance burden of two installation paths. Plugin approach is
strictly better for Claude Code users.

*** Single repo with plugin structure

Could restructure this repo to BE the plugin (add .claude-plugin/ at root).

Rejected: This repo contains documentation and design docs that shouldn't be
in the plugin. Better to have a separate plugin repo or subdirectory.

*** Plugin as subdirectory

Keep everything in this repo but have a =plugin/= subdirectory that IS the
plugin.

This is viable and worth considering. Tradeoff is URL complexity:
=github:farra/dev-agent-backlog/plugin= vs =github:farra/backlog-plugin=

* Questions                                                      :questions:

** DECIDED Separate repo or subdirectory?
:PROPERTIES:
:DECIDED: [2026-01-26]
:END:

*Decision:* This repo becomes a marketplace containing the backlog plugin.

The =plugin/= subdirectory contains the installable plugin. A =marketplace.json=
at the repo root lists available plugins. Installation:

#+begin_example
/plugin marketplace add farra/dev-agent-backlog
/plugin install backlog@farra-dev-agent-backlog
#+end_example

Rationale:
- Single source of truth (plugin and docs together)
- This repo dogfoods its own system
- Marketplace approach required by Claude Code for GitHub installs

** DECIDED What goes in CLAUDE.md vs stays in plugin?
:PROPERTIES:
:DECIDED: [2026-01-26]
:END:

*Decision:*
- Plugin skills: HOW to do things (task-queue mechanics, workflow steps)
- Project CLAUDE.md: WHAT this project uses (design doc locations, project prefix)

The =setup= skill writes a minimal CLAUDE.md section pointing to plugin commands.

** DECIDED How to handle template customization?
:PROPERTIES:
:DECIDED: [2026-01-26]
:END:

*Decision:* Start simple - users edit files after setup. Add config later if needed.

The templates provide sensible defaults. Users customize by editing:
- =README.org= for categories/statuses
- =org-setup.org= for org-mode settings
- Individual design docs as needed

** DECIDED Support for other coding agents?
:PROPERTIES:
:DECIDED: [2026-01-26]
:END:

*Decision:* Claude Code first, document for portability, adapters later if demand.

Research findings on other agents:
- *OpenAI Codex*: Has "agent skills" (similar concept), MCP support, slash commands
- *Google Gemini CLI*: Has "extensions" with "playbooks", MCP support
- *OpenCode*: Has JS/TS plugins, custom commands/agents, MCP support

All support MCP and custom instructions. The design doc methodology (org files,
backlog pattern) is agent-agnostic. Only the plugin/skill format differs.

Future: Could add =adapters/codex/=, =adapters/gemini-cli/= directories with
agent-specific skill formats. For now, document that methodology works with any
agent that can read/write files.

* Tasks                                                              :tasks:

** DONE [DAB-011-01] Create plugin directory structure                   :p0:
CLOSED: [2026-01-26]
:PROPERTIES:
:EFFORT: S
:COMPLETED_BY: claude-code
:END:

Create =plugin/= directory with =.claude-plugin/plugin.json= manifest.

** DONE [DAB-011-02] Migrate commands to plugin                          :p0:
CLOSED: [2026-01-26]
:PROPERTIES:
:EFFORT: S
:COMPLETED_BY: claude-code
:END:

Copy commands from =.claude/commands/= to =plugin/commands/=.

** DONE [DAB-011-03] Migrate skills to plugin                            :p0:
CLOSED: [2026-01-26]
:PROPERTIES:
:EFFORT: S
:COMPLETED_BY: claude-code
:END:

Copy skills from =.claude/skills/= to =plugin/skills/=.

** DONE [DAB-011-04] Create setup skill                                  :p1:
CLOSED: [2026-01-26]
:PROPERTIES:
:EFFORT: M
:COMPLETED_BY: claude-code
:END:

Write =plugin/skills/setup/SKILL.md= that replaces init.sh functionality.

** DONE [DAB-011-05] Copy templates to plugin                            :p0:
CLOSED: [2026-01-26]
:PROPERTIES:
:EFFORT: S
:COMPLETED_BY: claude-code
:END:

Copy =templates/= directory into plugin.

** TODO [DAB-011-06] Test plugin locally                                 :p1:
:PROPERTIES:
:EFFORT: M
:END:

Use =claude --plugin-dir ./plugin= to test all commands and skills.

** DONE [DAB-011-07] Write plugin README                                 :p1:
CLOSED: [2026-01-26]
:PROPERTIES:
:EFFORT: S
:COMPLETED_BY: reconciliation
:END:

Document installation and usage for plugin users.

** DONE [DAB-011-08] Decide on repo strategy                             :p1:
CLOSED: [2026-01-26]
:PROPERTIES:
:EFFORT: S
:COMPLETED_BY: claude-code
:END:

Decision: This repo becomes a marketplace. See DECIDED questions above.

** DONE [DAB-011-09] Deprecate init.sh                                   :p2:
CLOSED: [2026-01-26]
:PROPERTIES:
:EFFORT: S
:COMPLETED_BY: reconciliation
:END:

Update init.sh to print deprecation warning pointing to plugin.

** DONE [DAB-011-10] Create marketplace.json                             :p0:
CLOSED: [2026-01-26]
:PROPERTIES:
:EFFORT: S
:COMPLETED_BY: reconciliation
:END:

Add =.claude-plugin/marketplace.json= to repo root listing the backlog plugin.

* References

- [[https://code.claude.com/docs/en/plugins][Claude Code Plugin Documentation]]
- [[https://code.claude.com/docs/en/skills][Skills Documentation]]
- [[file:001-system-overview.org][001 - System Overview]]
- [[file:002-design-docs.org][002 - Design Doc Pattern]]

* Changelog

- *2026-01-26:* Decided on marketplace approach; researched other coding agents
- *2026-01-26:* Completed tasks 01-05, 08; plugin structure in place
- *2026-01-26:* Initial draft
